<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
<title>笔遇</title>
<link rel="stylesheet" href="../ytfui/css/ytfui.css" />
<link rel="stylesheet" href="../css/main.css" />
</head>

<body class="nav-fixed">
<div class="p30 pb20 fz24 c99"> 亲！先选择您的动态分类吧！ </div>
<div class="mb30 p30 bgff bb yt yt-ac">
  <label class="db yt-f1"> <i class="input-radio input-radio-green">
    <input name="fenlei" type="radio" value="3" checked="checked">
    <span></span></i> <span class="fz32 c33 ml10">分享</span> </label>
  <label class="db yt-f1"> <i class="input-radio input-radio-green">
    <input name="fenlei" type="radio" value="2">
    <span></span></i> <span class="fz32 c33 ml10">征友</span> </label>
  <label class="db yt-f1"> <i class="input-radio input-radio-green">
    <input name="fenlei" type="radio" value="1">
    <span></span></i> <span class="fz32 c33 ml10">公开信</span> </label>
</div>
<div class="mb30 plr30 bgff bt bb">
  <textarea class="input-text pt0 pb0 pl0 pr0 bgn bn mt30 mb30 h150-hmc" placeholder="这一刻你想说点啥呢..."></textarea>
  <div class="pub-upload-img-list pb10">
    <ul class="clear">
      <li>
        <label id="uploadImg">
          <input type="button"/>
        </label>
        <div class="img-wrap mt20 select_img_list"></div>
      </li>
    </ul>
  </div>
</div>
<div class="m30 ptb30 yt yt-ac">
  <button class="btn btn-b bg-green db yt-f1" id="addOk">发布</button>
</div>
<div class="m30" id="tipShow-box" style="display:none;">
  <h3 class="list-title tx-c mb20">小贴士</h3>
  <p class="fz28 c33 lh16 mb10 wb-ba-hmc">分享：<span class="c66">可以手写一段随笔、摘抄、美文等，也可以分享下你今天的心情或者美照！</span></p>
  <p class="fz28 c33 lh16 mb10 wb-ba-hmc">征友：<span class="c66">简单自我介绍，希望结识怎么样的笔友，是否愿意写头信。</span></p>
  <p class="fz28 c33 lh16 mb10 wb-ba-hmc">公开信：<span class="c66">写封信给自己、曾经的友人、恋人或者父母...并且愿意与大家分享！</span></p>
  <p class="fz28 c33 lh16 mb10 wb-ba-hmc">PS：<span class="c66">亲笔手写后拍照上传哦！</span></p>
  <div class="yt yt-ac yt-pe">
    <label> <i class="input-checkbox input-checkbox-hmc">
      <input type="checkbox" name="tipShow" id="tipShow" onChange="setTipShow()">
      <span></span></i> <span class="fz28 c66">不再提示</span> </label>
  </div>
</div>

<!--dialog begin-->
<div class="dialog-wrap">
    <div class="action-main">
        <div class="action-content">
            <button value="1">拍照获取</button>
            <button value="2">相册获取</button>
        </div>
        <button class="action-cancel"  onclick="$(this).closest('.dialog-wrap').removeClass('dialog-show')">取消</button>
    </div>
    <!--<div class="dialog-mark"></div>-->
</div>
<!--dialog end-->
</body>
<script src="../script/zepto.min.js" type="text/javascript"></script>
<script src="../script/common.js" type="text/javascript"></script>
<script src="../ytfui/js/html-size-calculation.js" type="text/javascript" charset="utf-8"></script>
<script>
imgArr = [];//远程图片集合
limgArr = [];//本地图片集合
ytfready = function(){
	//分享事件监听
	YTF.eventListenerAdd({
		　eventName: 'resShare'
		},function(ret,err){
		　　if(ret){
				YTF.winClose();
		　　}
		});
	
	if(!localStorage.getItem("tipShow")){
		$("#tipShow-box").show();
		}
	$("#addOk").bind("tap",function(){
		category = $("input[name='fenlei']:checked").val();
		content = $(".input-text").val();
		if(!category){
				YTF.toast({
						msg:"请选择一个分类",
						duration:2000,
						global:false,
					});
					return;
			}
		if(!content.replace(/(^\s*)|(\s*$)/g,'')){
				YTF.toast({
						msg:"发布内容不能为空",
						duration:2000,
						global:false,
					});
					return;
			}

		showProgress("数据提交中...");
		if(limgArr.length){
			upload();
			}else{
				putData();
				}
		})
	}
	
$("#uploadImg").bind("tap",function(){
		$(".dialog-wrap").toggleClass("dialog-show");
	})
$(".action-content").delegate("button","tap",function(){
	var type = $(this).val();
	if(type == 1){
			YTF.mediaGetPicture({
					isEdit: false,
					isCheckbox: false
			},
			function(ret, err) {
					if (ret){
						limgArr.push(ret.imagePath[0]);
						$(".img-wrap").append('<img src="'+ret.imagePath[0]+'" />');
						$(".img-wrap").show();
						}
			});
		}
	if(type == 2){
			YTF.mediaGetPicture({
					isEdit: false,
					isCheckbox: false
			},
			function(ret, err) {
					if (ret){
						limgArr.push(ret.imagePath[0]);
						$(".img-wrap").append('<img src="'+ret.imagePath[0]+'" />');
						$(".img-wrap").show();
						}
			});
		}
	$(".dialog-wrap").toggleClass("dialog-show");
	})
	
function putData(){
	YTF.ajax({　
			url: serverUrl + 'app/dynamic/add',
			methodType:'post',
			isReport:false,
			headers:{
			   logtoken:userToken
			},
			data : {
				values : {
					'category' : category,
					'content' : content,
					'img' : imgArr.join(",")
				}
			}
	},function(ret, err){
		YTF.hideProgress();
		if(ret){
			console.log("发布动态："+JSON.stringify(ret));
			if(ret.status == 0){
				openLoginWin("login_win","./login_win.html");
			}else if(ret.status == 1){
			YTF.eventSend({
				　eventName: 'resLsit',
				　attr: {
				　　type: 'resIndex'
				　　}
				},function(ret,err){
				　　if(ret){
						//////
				　　}
				});
				if(category == 3){
						YTF.winOpen({
							winName : "share",
							htmlUrl : "./share.html",
							htmlParam : {
								id : ret.data.id,
								wind : "add"
							}
						});
						YTF.toast({
									msg:ret["data"].integral_msg,
									duration:2000,
									global:false,
								});
					}else{
						YTF.toast({
									msg:ret["data"].integral_msg,
									duration:2000,
									global:false,
								});
						window.setTimeout(function(){
							YTF.winClose();
							},1800);
						}
				}else{
					YTF.toast({
								msg:ret.msg,
								duration:2000,
								global:false,
							});
					}
		}else{
			YTF.toast({
						msg:"网络错误",
						duration:2000,
						global:false,
					});
		}
	})
}
function setTipShow(){
	if($("#tipShow").is(":checked")){
		localStorage.setItem("tipShow",1);
		$("#tipShow-box").hide();
		}else{
			localStorage.removeItem("tipShow");
			}
}

function upload(){
	if(limgArr.length){
		YTF.ajax({
				url: serverUrl + 'app/user/upimg',
				methodType:'post',
				isReport:false,
				data: {
					files:{
							s:[limgArr[0]]
						  }
					}
				},function(ret,err){
						if(ret){
							if(ret.status == 1){
								limgArr.splice(0,1);
								imgArr.push(ret.data.path);
								}
							upload();
						}else{
							console.log(JSON.stringify(err));
						}
				});
	}else{
		putData();
		}
}
</script>
</html>